---
layout: post
category: js
title: 南京大学学分绩 GPA 计算
---
今天一时犯贱想要算算自己的学分绩(确实是犯贱啊!), 然后发现手动计算实在太麻烦了, 于是写了下面这个脚本来自动计算学分绩.

## 使用方法

1.将下面的这个链接拖拽到你的书签栏.  
<a href="javascript:(function(){var scores=0;var grades=0;var href_array=[];var fin_count=0;var all=[];set_href_array(document.getElementsByTagName('table')[1]);for(var i=0;i<href_array.length;i++){open(href_array[i]).addEventListener('load',function(){handler(this);});}function trim(str){return str.replace(/^\s*/,'').replace(/\s*$/,'');}function set_href_array(link_table){var trs=link_table.children[0].children;var a;for(var i=0;i<trs.length;i++){a=trs[i].getElementsByTagName('a');if(a.length==0){continue;}href_array.push(a[0].href);}href_array.pop();}function handler(win){var table_body=win.document.getElementsByClassName('TABLE_BODY');var trs=table_body[0].getElementsByTagName('tr');var tds,name,type,ul,score;for(var i=1;i<trs.length;i++){tds=trs[i].getElementsByTagName('td');type=trim(tds[4].innerHTML);ul=tds[6].children[0];if(ul==undefined){continue;}name=trim(tds[2].innerHTML);score=Number(tds[5].innerHTML);grade=Number(ul.innerHTML);all.push({'name':name,'score':score,'grade':grade});scores+=score;grades+=grade*score;}fin_count++;check();win.close();}function check(){if(fin_count==href_array.length){var str='';for(var i=0;i<all.length;i++){str+=all[i].score+'\t'+all[i].grade+'\t'+all[i].name+'\n';}str+='GPA: '+(grades/scores)/20;alert(str);}}})()">NJU GPA</a>

2.登录教服平台, 并进入成绩查看页面.

3.点击刚才添加到书签栏的书签, 稍等片刻即可看到结果.

*ps.所有具有成绩的课程都纳入到了学分绩的计算当中*

## 后话

由于教服平台上并不是在一个页面将所有成绩展示出来, 所以需要读取多个页面的数据后才能进行计算, 但是页面一刷新, 脚本就无法再运行下去了. 一开始想用 Frame 来解决这个问题, 后来因为 <acronym title="Same Origin Policy">SOP</acronym> 的原因而告失败.

最后解决的办法是通过 window.open() 打开子窗口, 然后对子窗口进行操作. 具体细节如果感兴趣的话, 自己分析下上面那个 Bookmarklet 的源码吧.

忽然想到今年补选通识课的时候, 利用按键精灵和 JS 实现了个简单粗暴的抢课插件, 当时之所以用到按键精灵就是因为抢课需要不停的刷新页面, 现在看来也可以利用操作子窗口的办法来实现个纯 JS 的抢课插件了.
